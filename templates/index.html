<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Coin Wallet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/elliptic/6.5.4/elliptic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; color: #333; }
        h1, h2 { color: #2c3e50; }
        .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .row { margin-bottom: 15px; }
        label { display: inline-block; width: 120px; font-weight: bold; }
        input[type="text"], input[type="number"] { padding: 8px; width: 60%; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button:hover { background-color: #2980b9; }
        button.danger { background-color: #e74c3c; }
        button.danger:hover { background-color: #c0392b; }
        .key-display { word-break: break-all; font-family: monospace; background: #eee; padding: 10px; margin-top: 5px; border-radius: 4px; font-size: 12px; }
        .mining-status { color: #e67e22; font-weight: bold; margin-left: 10px; display: none; }
        .mining-success { color: #27ae60; font-weight: bold; margin-left: 10px; display: none; }
        
        /*ブロックチェーン表示用のスタイル*/
        .block-container {
            font-family: monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 5px;
            overflow-x: hidden; /*横スクロール防止*/
            white-space: pre-wrap; /*改行を反映*/
            word-break: break-all; /*長い単語（ハッシュや鍵）を強制的に折り返す*/
        }
        .block-separator { color: #95a5a6; margin: 20px 0; border-bottom: 1px dashed #7f8c8d; padding-bottom: 20px; }
        
        /*トランザクション表示用のスタイル*/
        .tx-block {
            margin-left: 20px;
            margin-bottom: 10px;
            padding-left: 10px;
            border-left: 2px solid #3498db; /* 左側に線を入れて視認性を上げる */
        }
        .tx-label { color: #bdc3c7; display: inline-block; width: 60px; }
    </style>
</head>
<body>

    <h1>My Coin Wallet</h1>

    <div class="section">
        <h2>鍵管理</h2>
        <div class="row">
            <button onclick="generateKeys()">鍵ペア生成</button>
            <button class="danger" onclick="resetLocalKeys()">鍵リセット</button>
        </div>
        <div class="row">
            <strong>公開鍵:</strong>
            <div id="view-public-key" class="key-display">未生成</div>
        </div>
        <div class="row">
            <strong>秘密鍵:</strong>
            <div id="view-private-key" class="key-display">未生成</div>
        </div>
    </div>

    <div class="section">
        <h2>残高確認</h2>
        <div class="row">
            <label>公開鍵:</label>
            <input type="text" id="balance-address" placeholder="公開鍵を入力">
            <button onclick="checkBalance()">確認</button>
        </div>
        <div class="row">
            <strong>残高:</strong> <span id="balance-result">---</span>
        </div>
    </div>

    <div class="section">
        <h2>送金</h2>
        <div class="row">
            <label>相手の公開鍵:</label>
            <input type="text" id="tx-recipient" placeholder="相手の公開鍵">
        </div>
        <div class="row">
            <label>金額:</label>
            <input type="number" id="tx-amount" placeholder="金額">
        </div>
        <div class="row">
            <button onclick="sendTransaction()">送金する</button>
        </div>
        <div id="tx-status" style="margin-top:10px;"></div>
    </div>

    <div class="section">
        <h2>マイニング</h2>
        <div class="row">
            <button onclick="startMining()">マイニング開始</button>
            <span id="mining-status" class="mining-status">マイニング中...</span>
            <span id="mining-success" class="mining-success">マイニング成功！</span>
        </div>
    </div>

    <div class="section">
        <h2>ブロックチェーン</h2>
        <div class="row">
            <button onclick="syncChain()">チェーン同期</button>
            <button class="danger" onclick="clearLocalChain()">ローカルデータ削除</button>
        </div>
        <div id="chain-container" class="block-container">
            </div>
    </div>

<script>
    const EC = elliptic.ec;
    const ec = new EC('secp256k1');

    window.onload = function() {
        loadKeys();
        syncChain();
        setupSSE();
    };

    function generateKeys() {
        const key = ec.genKeyPair();
        localStorage.setItem('publicKey', key.getPublic('hex'));
        localStorage.setItem('privateKey', key.getPrivate('hex'));
        loadKeys();
    }

    function loadKeys() {
        const pub = localStorage.getItem('publicKey');
        const priv = localStorage.getItem('privateKey');
        document.getElementById('view-public-key').innerText = pub || "未生成";
        document.getElementById('view-private-key').innerText = priv || "未生成";
        if(pub) document.getElementById('balance-address').value = pub;
    }

    function resetLocalKeys() {
        localStorage.removeItem('publicKey');
        localStorage.removeItem('privateKey');
        loadKeys();
    }

    function getLocalChain() {
        const chain = localStorage.getItem('blockchain');
        return chain ? JSON.parse(chain) : [];
    }

    function saveLocalChain(chain) {
        localStorage.setItem('blockchain', JSON.stringify(chain));
        renderChain(chain);
    }

    function clearLocalChain() {
        localStorage.removeItem('blockchain');
        renderChain([]);
    }

    async function syncChain() {
        const localChain = getLocalChain();
        try {
            const response = await fetch('/nodes/resolve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chain: localChain })
            });
            const data = await response.json();
            if (data.chain) {
                saveLocalChain(data.chain);
            }
        } catch (e) {
            console.error("Sync error:", e);
        }
    }

    async function sendTransaction() {
        const senderPub = localStorage.getItem('publicKey');
        const senderPriv = localStorage.getItem('privateKey');
        const recipient = document.getElementById('tx-recipient').value;
        const amount = document.getElementById('tx-amount').value;

        if (!senderPub || !senderPriv) {
            document.getElementById('tx-status').innerText = "エラー: 鍵ペアがありません";
            return;
        }

        const msg = senderPub + recipient + amount;
        const msgHash = CryptoJS.SHA256(msg).toString();
        const key = ec.keyFromPrivate(senderPriv);
        const signature = key.sign(msgHash).toDER('hex');

        try {
            const response = await fetch('/transactions/new', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sender: senderPub,
                    recipient: recipient,
                    amount: amount,
                    signature: signature
                })
            });
            const data = await response.json();
            document.getElementById('tx-status').innerText = data.message;
            if(data.status === 'success') {
                document.getElementById('tx-recipient').value = '';
                document.getElementById('tx-amount').value = '';
            }
        } catch (e) {
            document.getElementById('tx-status').innerText = "送信エラー";
        }
    }

    async function checkBalance() {
        const address = document.getElementById('balance-address').value;
        if (!address) return;
        await syncChain();
        try {
            const response = await fetch('/balance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: address })
            });
            const data = await response.json();
            document.getElementById('balance-result').innerText = data.balance + " コイン";
        } catch (e) { console.error(e); }
    }

    async function startMining() {
        const myPub = localStorage.getItem('publicKey');
        if (!myPub) {
            const statusEl = document.getElementById('mining-status');
            statusEl.innerText = "エラー: 公開鍵がありません";
            statusEl.style.display = "inline";
            setTimeout(() => { statusEl.style.display = "none"; statusEl.innerText = "マイニング中..."; }, 3000);
            return;
        }

        document.getElementById('mining-status').style.display = "inline";
        try {
            const response = await fetch('/mine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ miner_address: myPub })
            });
            if (response.ok) {
                document.getElementById('mining-status').style.display = "none";
                const successEl = document.getElementById('mining-success');
                successEl.style.display = "inline";
                setTimeout(() => { successEl.style.display = "none"; }, 3000);
            }
        } catch (e) {
            console.error(e);
            document.getElementById('mining-status').style.display = "none";
        }
    }

    function setupSSE() {
        const evtSource = new EventSource("/events");
        evtSource.onmessage = function(event) {
            if (event.data.includes("new_block")) {
                syncChain();
            }
        };
    }

    // --- 表示フォーマットの変更（公開鍵フル表示対応） ---
    function renderChain(chain) {
        const container = document.getElementById('chain-container');
        if (!chain || chain.length === 0) {
            container.innerText = "チェーンデータがありません";
            return;
        }

        let output = "";

        chain.forEach((block, index) => {
            // 日付フォーマット変換
            let dateStr = "";
            try {
                const date = new Date(block.timestamp);
                const year = date.getFullYear();
                const month = ('0' + (date.getMonth() + 1)).slice(-2);
                const day = ('0' + date.getDate()).slice(-2);
                const hours = ('0' + date.getHours()).slice(-2);
                const minutes = ('0' + date.getMinutes()).slice(-2);
                const seconds = ('0' + date.getSeconds()).slice(-2);
                dateStr = `${year}/${month}/${day}  ${hours}:${minutes}:${seconds}`;
            } catch(e) {
                dateStr = block.timestamp;
            }

            output += `Block #${block.index}\n`;
            output += `Timestamp: ${dateStr}\n`;
            output += `Nonce: ${block.proof}\n`;
            output += `Hash: ${block.hash}\n`;
            output += `Prev: ${block.previous_hash}\n`;
            output += `Transactions:\n`;

            if (block.transactions && block.transactions.length > 0) {
                block.transactions.forEach(tx => {
                    // 送信者（システム報酬の場合は特別な表記、それ以外は生の公開鍵）
                    let sender = tx.sender === "0" ? "SYSTEM (REWARD)" : tx.sender;
                    let recipient = tx.recipient;
                    
                    // HTML構造を使ってインデントとフル表示を実現
                    // CSSの .tx-block で左側の線とインデントを制御
                    output += `<div class="tx-block">`;
                    output += `   <span class="tx-label">From:</span>   ${sender}\n`;
                    output += `   <span class="tx-label">To:</span>     ${recipient}\n`;
                    output += `   <span class="tx-label">Amount:</span> ${tx.amount}\n`;
                    output += `</div>`;
                });
            } else {
                output += `   (なし)\n`;
            }

            // 最後のブロック以外には区切り線を入れる
            if (index < chain.length - 1) {
                output += `<div class="block-separator"></div>`;
            }
        });

        container.innerHTML = output;
    }
</script>

</body>
</html>





